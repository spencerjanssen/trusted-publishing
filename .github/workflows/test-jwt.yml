name: Test JWT Generation

on:
  push:
    branches:
        - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  test-jwt:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get JWT token
      id: get-jwt
      run: |
        AUDIENCE="https://github.com/${{ github.repository }}"
        RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=$AUDIENCE")
        JWT_TOKEN=$(echo "$RESPONSE" | jq -r '.value // empty')
        
        if [ -n "$JWT_TOKEN" ] && [ "$JWT_TOKEN" != "null" ]; then
          echo "$JWT_TOKEN" > .jwt-token
          chmod 600 .jwt-token
          echo "jwt-token=$JWT_TOKEN" >> $GITHUB_OUTPUT
        else
          echo "ERROR: Failed to get JWT token"
          exit 1
        fi

    - name: Run Haskell integration test
      run: |
        cabal update
        cabal run gh-integration-test
