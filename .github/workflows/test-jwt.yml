name: Test JWT Generation

on:
  push:
    branches:
        - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  test-jwt:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v31
    - uses: cachix/cachix-action@v16
      with:
        name: sjanssen-trusted-publishing
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Get JWT token
      id: get-jwt
      run: |
        RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=$AUDIENCE")
        JWT_TOKEN=$(echo "$RESPONSE" | jq -r '.value // empty')
        
        if [ -n "$JWT_TOKEN" ] && [ "$JWT_TOKEN" != "null" ]; then
          echo "$JWT_TOKEN" > .jwt-token
          chmod 600 .jwt-token
          echo "jwt-token=$JWT_TOKEN" >> $GITHUB_OUTPUT
        else
          echo "ERROR: Failed to get JWT token"
          exit 1
        fi
    - name: Run gh-integration-test
      run: |
        AUDIENCE="https://github.com/${{ github.repository }}" \
        REPO="${{ github.repository }}" \
        REPO_ID="${{ github.repository_id }}" \
        REPO_OWNER="${{ github.repository_owner }}" \
        WORKFLOW_FILE_NAME="${{ github.workflow }}" \
        nix run .#gh-integration-test
